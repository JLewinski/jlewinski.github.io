var confirmedUSDataUrl="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv",confirmedGlobalDataUrl="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv",fatalUSDataUrl="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv",fatalGlobalDataUrl="https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv",dataKeys=["confirmed","confirmedTimeData","fatality","fatalityTimeData","fatalityRatioData"],basicDataKeys=["confirmed","fatality"];function SliceData(x,y){return x.slice(y.startDateIndex,1*y.endDateIndex+1)}var chartOptions={confirmed:{type:"line",dataAction:SliceData},confirmedTimeData:{type:"bar",dataAction:SliceData},fatality:{type:"bar",dataAction:SliceData},fatalityTimeData:{type:"bar",dataAction:SliceData},fatalityRatioData:{type:"bar",maxY:25}};function CreatePlot(self,dataKey,data,title,subDates){var options=chartOptions[dataKey],ctx=document.getElementById(dataKey+self.id),color=randomColorString(),dataset={data:options.dataAction?options.dataAction(data,self):data,backgroundColor:color,borderColor:color},chart;return new Chart(ctx,{type:options.type,data:{labels:subDates,datasets:[dataset]},options:{legend:{display:!1},title:{display:!0,text:title}}})}var MyLocation=function(){function MyLocation(locationData,dataKey,indexes){var possibleNames;if(this.data={},this.children={},locationData.length>4){var numStartIndex=indexes[0],latitudeIndex=indexes[1],longitudeIndex=indexes[2],stateIndex=indexes[3],countryIndex=indexes[4],cityIndex=indexes[5],populationIndex=indexes[6];possibleNames=[cityIndex,stateIndex,countryIndex].filter((function(x){return x>=0})).map((function(x){return locationData[x]})).filter((function(x){return x})).map((function(x){return x.replace(/;/g,",")})),this.latitude=parseInt(locationData[latitudeIndex]),this.longitude=parseInt(locationData[longitudeIndex]),this.population=0,populationIndex&&(this.population=parseInt(locationData[populationIndex])),this.data[dataKey]=locationData.slice(numStartIndex).map((function(x){return parseInt(x)}))}else possibleNames=locationData;this.name=possibleNames[0],this.key=possibleNames.join(", "),this.names=["All"]}return MyLocation.prototype.GetData=function(key){var _this=this,data;return this.data[key]?(this.populationChecked||this.GetPopulation(),this.data[key]):(this.populationChecked=!0,this.population=0,this.names.filter((function(x){return"All"!=x})).forEach((function(x){var childData=_this.children[x].GetData(key);data?childData.forEach((function(val,i){return data[i]+=val})):data=childData.map((function(x){return x}))})),this.data[key]=data,this.data[key])},MyLocation.prototype.GetPopulation=function(){var _this=this;return this.populationChecked||this.population?this.population:(this.populationChecked=!0,this.population=0,this.names.filter((function(x){return"All"!=x})).forEach((function(x){_this.population+=_this.children[x].GetPopulation()})),this.population)},MyLocation.prototype.GetTimeData=function(key){for(var data=this.data[key],timeData=[],i=1;i<data.length;i++){var temp=data[i]-data[i-1];timeData.push(temp>0?temp:0)}return this.data[key+"TimeData"]=timeData,this.data[key+"TimeData"]},MyLocation.prototype.GetRange=function(key,startIndex,endIndex){return this.data[key][endIndex]-startIndex>0?this.data[key][startIndex-1]:0},MyLocation}();function randomColorString(){function randRGB(){return Math.floor(255*Math.random())-1}return"rgb("+randRGB()+","+randRGB()+","+randRGB()+")"}var ChartGroup=function(){function ChartGroup(vm){this.id=vm.lastID++,this.selectedCountryName="",this.selectedStateName="",this.selectedCityName="",this.selectedCity=null,this.selectedState=null,this.selectedCountry=null,this.offset=5,this.range=5,this.startDateIndex=42,this.endDateIndex=Number.MAX_VALUE,this.charts=[],this.locationRoot=vm,this.dates=vm.dates,ko.track(this)}return ChartGroup.prototype.updateCharts=function(){var _this=this,_a,_b,_c,_d;this.selectedCountry=this.locationRoot.children[this.selectedCountryName],this.selectedState=this.selectedCountry.children[this.selectedCityName],this.selectedCity=null===(_a=this.selectedState)||void 0===_a?void 0:_a.children[this.selectedCityName];var location=null!==(_c=null!==(_b=this.selectedCity)&&void 0!==_b?_b:this.selectedState)&&void 0!==_c?_c:this.selectedCountry;basicDataKeys.forEach((function(x){location.GetData(x),location.GetTimeData(x)})),this.endDateIndex>=location.data.confirmedTimeData.length&&(this.endDateIndex=location.data.confirmedTimeData.length-1),location.data.fatalityRatioData=[];for(var i=this.startDateIndex;i<=this.endDateIndex-this.range-this.offset;i++){var confirmed=location.data.confirmedTimeData.slice(i,i+this.range).reduce((function(a,b){return a+b})),fatal=location.data.fatalityTimeData.slice(i+this.offset,i+this.offset+this.range).reduce((function(a,b){return a+b})),ratio=confirmed?fatal/confirmed*100:fatal;location.data.fatalityRatioData.push(ratio)}var totalCases=location.GetRange("confirmed",this.startDateIndex,this.endDateIndex),totalFatalCases=location.GetRange("confirmed",this.startDateIndex,this.endDateIndex),totalFatality=totalFatalCases/totalCases*100,popTitle=location.name+" Total Cases",fatTitle=location.name+" Total Fatal Cases";if(location.population){var populationPercentage=totalCases/location.population*100,popFatPercentage=totalFatalCases/location.population*100;popTitle+=" ("+populationPercentage.toFixed(2)+"% of Population)",fatTitle+=" ("+popFatPercentage.toFixed(2)+"% of Population)"}var titles={confirmed:popTitle,confirmedTimeData:location.name+" Confirmed Cases ("+totalCases+" total)",fatalityTimeData:location.name+" Fatal Cases ("+totalFatalCases+" total)",fatalityRatioData:location.name+" Morality Rate ("+totalFatality.toFixed(2)+"% total morality rate)",fatality:fatTitle},subDates=this.dates.slice(this.startDateIndex,this.endDateIndex+1);this.charts||(this.charts=[]),(null===(_d=this.charts)||void 0===_d?void 0:_d.length)?this.charts.forEach((function(x){return UpdateChart(_this,x.chart,x.name,location.data[x.name],titles[x.name],subDates)})):dataKeys.forEach((function(x,i){_this.charts.push({name:x}),_this.charts[i].chart=CreatePlot(_this,x,location.data[x],titles[x],subDates)}))},ChartGroup}();function UpdateChart(self,chart,dataKey,data,title,subDates){var options=chartOptions[dataKey];chart.data.datasets[0].data=options.dataAction?options.dataAction(data,self):data,chart.options.title.text=title,chart.data.labels=subDates,chart.update()}var ViewModel=function(){function ViewModel(){var _this=this,dataOptions;this.children={},this.chartGroups=[],this.names=[],this.lastID=0,this.dates=[],this.countdown=3;for(var tempDate=moment(new Date("1/22/20"));tempDate<moment();)this.dates.push(tempDate.format("l")),tempDate.add(1,"days");function getCOVID19JohnsHopkinsData(options,vm){$.get(options.url).done((function(result){vm.addLocations(result,options.dataKey,options.indexParams),vm.addGroup()}))}[{url:confirmedGlobalDataUrl,indexParams:[4,2,3,0,1],dataKey:"confirmed",getData:getCOVID19JohnsHopkinsData},{url:confirmedUSDataUrl,indexParams:[11,8,9,6,7,5],dataKey:"confirmed",getData:getCOVID19JohnsHopkinsData},{url:fatalGlobalDataUrl,indexParams:[4,2,3,0,1],dataKey:"fatality",getData:getCOVID19JohnsHopkinsData},{url:fatalUSDataUrl,indexParams:[12,8,9,6,7,5,11],dataKey:"fatality",getData:getCOVID19JohnsHopkinsData}].forEach((function(x){return x.getData(x,_this)})),ko.track(this),ko.applyBindings(this)}return ViewModel.prototype.addGroup=function(){if(0>=this.countdown--){var chartGroup=new ChartGroup(this);chartGroup.selectedCountryName="US",this.chartGroups.push(chartGroup),chartGroup.updateCharts()}},ViewModel.prototype.addLocation=function(location,dataKey){var key=location.key.split(", ").reverse().filter((function(x){return x})),i,parent=this,parentKey="";for(i=0;i<key.length-1;i++)parentKey=parentKey?key[i]+", "+parentKey:key[i],parent.children[key[i]]||(parent.names.push(key[i]),parent.children[key[i]]=new MyLocation(parentKey.split(", "))),parent=parent.children[key[i]];parent.names.push(key[i]),parent.children[key[i]]?(parent.children[key[i]].data[dataKey]=location.data[dataKey],parent.children[key[i]].population||(parent.children[key[i]].population=location.population)):parent.children[key[i]]=location},ViewModel.prototype.addLocations=function(csv,dataKey,indexes){var _this=this;csv.split("\n").slice(1).filter((function(x){return x})).forEach((function(data){var location=new MyLocation(GetLocationData(data),dataKey,indexes);_this.addLocation(location,dataKey)}))},ViewModel}();function GetLocationData(locationCSV){var temp=locationCSV.split('"');locationCSV="";for(var i=0;i<temp.length;i++)locationCSV+=i%2?temp[i].replace(/,/g,";"):temp[i];return locationCSV.split(",")}