<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>COVID-19 Statistics</title>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css" />
    <base href="https://jlewinski.github.io/" />

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href='#'>JLewinski</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/covid19.html">Covid-19</a>
                </li>
                <!-- <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Dropdown
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="#">Action</a>
                            <a class="dropdown-item" href="#">Another action</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Something else here</a>
                        </div>
                    </li> -->
                <!-- <li class="nav-item">
                        <a class="nav-link disabled" href="#">Disabled</a>
                    </li> -->
            </ul>
            <!-- <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                </form> -->
        </div>
    </nav>
    <div class="row">
        <small>All data from <a href="https://github.com/CSSEGISandData/COVID-19">Johns Hopkins University</a></small>
    </div>
    <h1>COVID-19 Data</h1>

    <div class="container" style="display: none;" data-bind="foreach: chartGroups, visible: confirmedCases">
        <div class="row">
            <div class="col-md-4 col-lg-3">
                <canvas data-bind="attr: { id: 'confirmedChart' + id }" id="confirmedChart" width="400"
                    height="400"></canvas>
            </div>
            <div class="col-md-4 col-lg-3">
                <canvas data-bind="attr: { id: 'fatalityChart' + id }" id="fatalityChart" width="400"
                    height="400"></canvas>
            </div>
            <div class="col-md-4 col-lg-3">
                <canvas data-bind="attr: { id: 'populationChart' + id }" id="populationChart" width="400"
                    height="400"></canvas>
            </div>
            <div class="col-md-4 col-lg-3">
                <canvas data-bind="attr: { id: 'fatalityRatioChart' + id }" id="fatalityRatioChart" width="400"
                    height="400"></canvas>
            </div>
        </div>
        <div class="row">
            <div class="col align-self-end text-right">
                <div class="slidecontainer">
                    <label>Offset (<span data-bind="text: offset"></span>)</label>
                    <input type="range" min="0" max="30" value="5" class="slider"
                        data-bind="value: offset, event: {change: updateCharts}" />
                </div>
                <div class="slidecontainer">
                    <label>Range (<span data-bind="text: range"></span>)</label>
                    <input type="range" min="1" max="30" value="5" class="slider"
                        data-bind="value: range, event: {change: updateCharts}" />
                </div>
                <div class="slidecontainer">
                    <label>Cuttoff Percentage (<span data-bind="text: cutoffRate"></span>)</label>
                    <input type="range" min="0.00" step="0.01" max="10" class="slider"
                        data-bind="value: cutoffRate, event: {change: updateCharts}" />
                </div>
            </div>
        </div>
        <div class="row">
            <div>
                <select class="form-control"
                    data-bind="options: $root.confirmedCases.names, value: selectedCountryName, event: { change: updateCharts }">
                    <option>US</option>
                </select>
            </div>
            <div data-bind="if: selectedCountry && selectedCountry.names && selectedCountry.names.length">
                <select class="form-control"
                    data-bind="options: selectedCountry.names, value: selectedStateName, event: { change: updateCharts }"
                    value="Alabama">
                    <option>Alabama</option>
                    <option>California</option>
                    <option>Colorado</option>
                    <option>Florida</option>
                    <option>Georgia</option>
                    <option>Maryland</option>
                    <option>New York</option>
                    <option>Ohio</option>
                </select>
            </div>
            <div data-bind="if: selectedState && selectedState.names && selectedState.names.length">
                <select class="form-control"
                    data-bind="options: selectedState.names, value: selectedCityName, event: { change: updateCharts }">
                </select>
            </div>
        </div>
    </div>
    <br />
    <div class="container">
        <div class="row">
            <button class="btn btn-primary" data-bind="click: $root.addGroup">Add Charts</button>
        </div>
    </div>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout-es5/0.4.6/knockout-es5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
    <script type="text/javascript">
        const confirmedUSDataUrl = 'https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv';
        const confirmedGlobalDataUrl = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv";
        const fatalUSDataUrl = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv";
        const fatalGlobalDataUrl = "https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv";

        var lastID = 0;
        var dates = [];
        var vm = {
            confirmedCases: LocationCollection(),
            fatalCases: LocationCollection(),
            chartGroups: []
        };

        function randomColorString() {
            var r = Math.floor(Math.random() * 255) - 1;
            var g = Math.floor(Math.random() * 255) - 1;
            var b = Math.floor(Math.random() * 255) - 1;
            return 'rgb(' + r + ',' + g + ',' + b + ')';
        }

        function CreatePlot(elementId, data, title, subDates, type) {
            var ctx = document.getElementById(elementId);
            var color = randomColorString();
            var dataset = {
                data: data,
                backgroundColor: color,
                borderColor: color
            };
            //default type is bar
            if (!type) { type = 'bar'; }
            return new Chart(ctx, {
                type: type,
                data: {
                    labels: subDates,
                    datasets: [dataset]
                },
                options: {
                    legend: {
                        display: false
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    },
                    title: {
                        display: true,
                        text: title
                    }
                }
            });
        }

        function GetData(location) {
            if (location.data) {
                if (!location.dataChecked) {
                    location.dataChecked = true;
                    location.data = location.data.map(x => x * 1);
                }
                return location.data;
            }
            location.dataChecked = true;
            location.populationChecked = true;
            location.population = 0;
            location.data = Array(location[location.names[Math.floor(location.names.length / 2)]].data.length).fill(0);
            location.names.filter(x => x != 'All').forEach(x => {
                var childData = GetData(location[x]);
                if (!location.data.length) {
                    childData.forEach(val => location.data.push(0));
                }
                for (var i = 0; i < location.data.length; i++) {
                    location.data[i] += childData[i] * 1;
                }
                location.population += location[x].population;
            });
            return location.data;
        }

        function GetPopulation(location) {
            if (location.population || location.populationChecked) {
                location.population *= 1;
                return location.population;
            }
            location.population = 0;
            location.populationChecked = true;
            location.names.filter(x => x != 'All').forEach(x => {
                var pop = GetPopulation(location[x]);
                location.population += pop;
            });
            location.population *= 1;
            return location.population;
        }

        function GetLocation(key, container) {
            var location = vm.fatalCases;
            key.split(', ').reverse().forEach(x => {
                location = location[x];
            });
            return location;
        }

        function GetFatalityLocation(key) {
            var faltalityLocation = vm.fatalCases;
            key.split(', ').reverse().forEach(x => {
                faltalityLocation = faltalityLocation[x];
            });
            return faltalityLocation;
        }

        function GetTimeData(data) {
            var timeData = [];
            for (var i = 1; i < data.length; i++) {
                var temp = data[i] - data[i - 1];
                timeData.push(temp < 0 ? 0 : temp);
            }
            return timeData;
        }

        function UpdateChart(chart, data, title, subDates) {
            chart.data.datasets[0].data = data;
            chart.options.title.text = title;
            chart.data.labels = subDates;
            chart.update();
        }

        function ChartGroup() {
            var self = {
                id: lastID++,
                selectedCountryName: '',
                selectedStateName: '',
                selectedCityName: '',
                selectedCountry: {},
                selectedState: {},
                selectedCity: {},
                offset: 5,
                range: 5,
                cutoffRate: 0.5
            };

            self.updateCharts = function () {
                self.selectedCountry = vm.confirmedCases[self.selectedCountryName];
                self.selectedState = self.selectedCountry[self.selectedStateName];
                self.selectedCity = self.selectedState ? self.selectedState[self.selectedCityName] : null;
                var location = self.selectedCity ?? self.selectedState ?? self.selectedCountry;
                GetData(location);
                if (!location.timeData) {
                    location.timeData = GetTimeData(GetData(location));
                }
                if (!location.fatalityData) {
                    var fatalLocation = GetFatalityLocation(location.key);
                    location.fatalityData = GetData(fatalLocation);
                    location.population = GetPopulation(fatalLocation);
                    location.fatalityTimeData = GetTimeData(location.fatalityData);
                }

                location.fatalityRatioData = [];
                location.timeData.forEach((val, index) => {
                    var confirmed = 0;
                    var fatal = 0;
                    var offset = self.offset * 1;
                    var range = self.range * 1;
                    for (var i = index; i < index + range; i++) {
                        confirmed += location.timeData[i];
                        fatal += location.fatalityTimeData[i + offset];
                    }
                    var ratio = confirmed ? fatal / confirmed * 100 : fatal;

                    location.fatalityRatioData.push(ratio.toFixed(2) * 1);
                });

                var firstIndex = 0;
                // var cutoff = location.fatalityData[location.fatalityData.length - 1] * self.cutoffRate / 100;
                var cutoff = location.data[location.data.length - 1] * self.cutoffRate / 100;
                while (location.data.length > firstIndex) {
                    // if (location.fatalityData[firstIndex] > cutoff) {
                    //     break;
                    // }
                    if (location.data[firstIndex] > cutoff) {
                        break;
                    }
                    firstIndex++;
                }

                var confirmedTitle = location.name + ' Confirmed Cases (' + location.data[location.data.length - 1] + ' total)';
                var fatalityTitle = location.name + ' Fatal Cases (' + location.fatalityData[location.fatalityData.length - 1] + ' total)';
                var totalFatality = location.fatalityData[location.fatalityData.length - 1] / location.data[location.data.length - 1] * 100;
                var fatalityRatioTitle = location.name + ' % Cases Fatal (' + totalFatality.toFixed(2) + '% of all cases fatal)';
                var popTitle = location.name + ' Total Cases';
                if (location.population) {
                    var popPercentage = location.data[location.data.length - 1] / location.population * 100;
                    popTitle += ' (' + popPercentage.toFixed(2) + '% of Population)';
                }

                var subDates = dates.slice(firstIndex);

                if (!self.confirmedChart) {
                    self.confirmedChart = CreatePlot('confirmedChart' + self.id, location.timeData.slice(firstIndex), confirmedTitle, subDates);
                    self.fatalityChart = CreatePlot('fatalityChart' + self.id, location.fatalityTimeData.slice(firstIndex), fatalityTitle, subDates);
                    self.fatalityRatioChart = CreatePlot('fatalityRatioChart' + self.id, location.fatalityRatioData.slice(firstIndex), fatalityRatioTitle, subDates);
                    // self.fatalityRatioChart.options.scales.yAxes[0].ticks.max = 25;
                    self.fatalityRatioChart.options.scales.yAxes[0].scaleLabel.labelString = 'Percent Fatal'
                    self.fatalityRatioChart.options.scales.yAxes[0].scaleLabel.display = true;
                    self.fatalityRatioChart.update();
                    self.populationChart = CreatePlot('populationChart' + self.id, location.data.slice(firstIndex), popTitle, subDates, 'line');
                } else {
                    UpdateChart(self.confirmedChart, location.timeData.slice(firstIndex), confirmedTitle, subDates);
                    UpdateChart(self.fatalityChart, location.fatalityTimeData.slice(firstIndex), fatalityTitle, subDates);
                    UpdateChart(self.fatalityRatioChart, location.fatalityRatioData.slice(firstIndex), fatalityRatioTitle, subDates);
                    UpdateChart(self.populationChart, location.data.slice(firstIndex), popTitle, subDates);
                }
            };

            ko.track(self);
            return self;
        };

        function LocationCollection() {
            var self = { names: ['All'] };
            self.addLocation = function (location) {
                var key = location.key.split(', ').reverse().filter(x => x);
                var i;
                var parent = self;
                var parentKey = '';
                for (i = 0; i < key.length - 1; i++) {
                    parentKey = parentKey ? key[i] + ', ' + parentKey : key[i];
                    if (!parent[key[i]]) {
                        parent.names.push(key[i]);
                        parent[key[i]] = { names: ['All'], name: key[i], key: parentKey };
                    }
                    parent = parent[key[i]];
                }
                parent.names.push(key[i]);
                parent[key[i]] = location;
            };
            return self;
        }

        function GetLocationData(locationCSV) {
            var temp = locationCSV.split('"');
            locationCSV = '';
            for (var i = 0; i < temp.length; i++) {
                if (i % 2) {
                    locationCSV += temp[i].replace(/,/g, ';');
                } else {
                    locationCSV += temp[i];
                }
            }
            return locationCSV.split(',');
        }

        function GetLocation(locationData, numStartIndex, latitudeIndex, longitudeIndex, stateIndex, countryIndex, cityIndex, populationIndex) {
            var possibleNames = [cityIndex, stateIndex, countryIndex]
                .filter(x => x >= 0)
                .map(x => locationData[x])
                .filter(x => x)
                .map(x => x.replace(/;/g, ','));

            var location = {
                name: possibleNames[0],
                latitude: locationData[latitudeIndex],
                longitude: locationData[longitudeIndex],
                population: populationIndex ? locationData[populationIndex] : 0,
                key: possibleNames.join(', '),
                data: locationData.slice(numStartIndex),
                names: ['All']
            };
            location.timeData = GetTimeData(location.data);
            return location;
        }

        function AddLocations(csv, storage, numStartIndex, latitudeIndex, longitudeIndex, stateIndex, countryIndex, cityIndex, populationIndex) {
            csv.split('\n').slice(1).filter(x => x).forEach(data => {
                var location = GetLocation(GetLocationData(data), numStartIndex, latitudeIndex, longitudeIndex, stateIndex, countryIndex, cityIndex, populationIndex);
                storage.addLocation(location);
            });
        }

        var countdown = 3;
        function Start() {
            if (0 >= countdown--) {
                var chartGroup = ChartGroup();
                chartGroup.selectedCountryName = 'US';
                vm.chartGroups.push(chartGroup);
                chartGroup.updateCharts();
            }
        }

        vm.addGroup = Start;

        $(() => {
            $.get(confirmedGlobalDataUrl).done(result => {
                AddLocations(result, vm.confirmedCases, 4, 2, 3, 0, 1);
                Start();
            });
            $.get(fatalGlobalDataUrl).done(result => {
                AddLocations(result, vm.fatalCases, 4, 2, 3, 0, 1);
                Start();
            });
            $.get(confirmedUSDataUrl).done(result => {
                AddLocations(result, vm.confirmedCases, 11, 8, 9, 6, 7, 5);
                Start();
            });
            $.get(fatalUSDataUrl).done(result => {
                AddLocations(result, vm.fatalCases, 12, 8, 9, 6, 7, 5, 11);
                Start();
            });

            var tempDate = moment(new Date('1/22/20'));
            while (tempDate < moment()) {
                dates.push(tempDate.format('l'));
                tempDate.add(1, 'days');
            }

            ko.track(vm.confirmedCases);
            ko.track(vm);
            ko.applyBindings(vm);
        });
    </script>
</body>